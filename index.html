import React, { useState, useEffect } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";

const YOUTUBE_FEEDS = {
  UCR0V48DJyWbwEAdxLL5FjxA: "日向坂46 OFFICIAL YouTube CHANNEL",
  UCOB24f8lQBCnVqPZXOkVpOg: "日向坂ちゃんねる",
};

const NEWS_API = "https://newsdata.io/api/1/news?apikey=demo&q=日向坂46&language=ja";

export default function Home() {
  const [view, setView] = useState<string | null>(null);
  const [channel, setChannel] = useState<string | null>(null);
  const [videos, setVideos] = useState<any[]>([]);
  const [news, setNews] = useState<any[]>([]);
  const [videoSort, setVideoSort] = useState("new");
  const [newsSort, setNewsSort] = useState("new");
  const [videoPageToken, setVideoPageToken] = useState<string | null>(null);
  const [videoList, setVideoList] = useState<any[]>([]);
  const [newsPage, setNewsPage] = useState<number>(1);

  useEffect(() => {
    if (channel) fetchYouTubeVideos();
  }, [channel]);

  useEffect(() => {
    fetchNews();
  }, [newsPage]);

  const fetchYouTubeVideos = async (loadMore = false) => {
    const channelId = channel;
    const apiKey = "YOUR_YOUTUBE_API_KEY"; // Replace with actual API key
    let url = `https://www.googleapis.com/youtube/v3/search?key=${apiKey}&channelId=${channelId}&part=snippet,id&order=date&maxResults=10`;
    if (loadMore && videoPageToken) url += `&pageToken=${videoPageToken}`;
    const res = await fetch(url);
    const data = await res.json();
    const fetchedVideos = data.items.filter((item: any) => item.id.videoId);
    setVideoList((prev) => [...prev, ...fetchedVideos]);
    setVideoPageToken(data.nextPageToken || null);
  };

  const fetchNews = async () => {
    const res = await fetch(`${NEWS_API}&page=${newsPage}`);
    const data = await res.json();
    setNews((prev) => [...prev, ...(data.results || [])]);
  };

  const sortedVideos = [...videoList].sort((a, b) => {
    const dateA = new Date(a.snippet.publishedAt).getTime();
    const dateB = new Date(b.snippet.publishedAt).getTime();
    return videoSort === "new" ? dateB - dateA : dateA - dateB;
  });

  const sortedNews = [...news].sort((a, b) => {
    const dateA = new Date(a.pubDate).getTime();
    const dateB = new Date(b.pubDate).getTime();
    return newsSort === "new" ? dateB - dateA : dateA - dateB;
  });

  return (
    <div className="p-4 space-y-4">
      {!view && (
        <div className="grid grid-cols-3 gap-4">
          {[
            { key: "youtube", label: "YouTube" },
            { key: "news", label: "関連ニュース" },
          ].map((item) => (
            <Button key={item.key} onClick={() => setView(item.key)}>
              {item.label}
            </Button>
          ))}
        </div>
      )}

      {view === "youtube" && !channel && (
        <div className="space-y-2">
          {Object.entries(YOUTUBE_FEEDS).map(([id, name]) => (
            <Button key={id} onClick={() => setChannel(id)}>
              {name}
            </Button>
          ))}
        </div>
      )}

      {view === "youtube" && channel && (
        <div className="space-y-2">
          <div className="flex gap-2">
            <Button onClick={() => setVideoSort("new")}>新しい順</Button>
            <Button onClick={() => setVideoSort("old")}>古い順</Button>
          </div>
          {sortedVideos.map((item, index) => (
            <Card key={index}>
              <CardContent>
                <a
                  href={`https://www.youtube.com/watch?v=${item.id.videoId}`}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <p>{item.snippet.title}</p>
                </a>
              </CardContent>
            </Card>
          ))}
          {videoPageToken && (
            <Button onClick={() => fetchYouTubeVideos(true)}>もっと見る</Button>
          )}
        </div>
      )}

      {view === "news" && (
        <div className="space-y-2">
          <div className="flex gap-2">
            <Button onClick={() => setNewsSort("new")}>新しい順</Button>
            <Button onClick={() => setNewsSort("old")}>古い順</Button>
          </div>
          {sortedNews.map((article, index) => (
            <Card key={index}>
              <CardContent>
                <a href={article.link} target="_blank" rel="noopener noreferrer">
                  <p>{article.title}</p>
                </a>
              </CardContent>
            </Card>
          ))}
          <Button onClick={() => setNewsPage((prev) => prev + 1)}>もっと見る</Button>
        </div>
      )}
    </div>
  );
}
